<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Landscape REPL</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:20px; }
    table.selection-table { border-collapse:collapse; margin:0 auto 20px; width:80%; max-width:800px; background:#fff; }
    table.selection-table th, table.selection-table td { border:1px solid #888; padding:6px 10px; text-align:center; }
    table.selection-table thead { background:#f0f0f0; font-weight:bold; }
    .tabs { text-align:center; margin-bottom:10px; }
    .tablink { display:inline-block; padding:8px 16px; margin:0 4px; border:0; border-radius:4px 4px 0 0; background:#ddd; cursor:pointer; font-size:14px; }
    .tablink.active { background:#366536; color:#fff; }
    .tabcontent { display:none; position:relative; }
    fieldset.control-block { display:block; margin:15px auto; padding:15px; width:400px; max-width:95%; border:1px solid #aaa; border-radius:6px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    fieldset.control-block legend { font-weight:bold; }
    fieldset.control-block label { display:inline-block; width:140px; text-align:right; margin-right:8px; }
    fieldset.control-block input[type="number"] { width:120px; padding:3px; margin:3px 0; }
    fieldset.control-block input[type="button"] { margin:4px 0; padding:4px 10px; cursor:pointer; }
    .info-box { margin-top:10px; padding:6px; background:#f9f9f9; border:1px dashed #aaa; font-size:12px; min-height:30px; white-space:pre-wrap; }
    a { display:block; text-align:center; margin-top:20px; }
    .tab-help { position:absolute; right:10px; bottom:10px; padding:8px 12px; border:0; border-radius:8px; background:#366536; color:#fff; font-weight:600; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.2); }
    .tab-help:hover { filter:brightness(1.05); }
    .tab-help:active { transform:translateY(1px); }
    #log-box { margin-top:10px; padding:8px; background:#111; color:#0f0; font-family:monospace; font-size:12px; height:140px; overflow:auto; }
    .muted { opacity:.6; }
  </style>

  <script type="text/javascript">
    "use strict";

    // ================= helpers =================
    function AddLog(msg) {
      const box = document.getElementById('log-box');
      if (!box) return;
      const now = new Date().toLocaleTimeString();
      box.textContent += "\n[" + now + "] " + msg;
      box.scrollTop = box.scrollHeight;
    }
    function setInfo(id, msg) {
      const el = document.getElementById(id);
      if (el) el.textContent = msg;
    }
    function parseNumber(inputEl, def = 0) {
      let v = (typeof inputEl.valueAsNumber === 'number' && !isNaN(inputEl.valueAsNumber)) ? inputEl.valueAsNumber : NaN;
      if (isNaN(v)) {
        const p = parseFloat(String(inputEl.value || "").replace(',', '.'));
        v = Number.isFinite(p) ? p : def;
      }
      return v;
    }

    // =============== –æ–∂–∏–¥–∞–Ω–∏–µ –º–æ—Å—Ç–∞ ACAPI (—Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π) ===============
    function whenACAPIReadyDo(cb) {
      let fired = false;
      const probe = () => {
        const A = window.ACAPI;
        if (!A) return null;
        return {
          hasSelect : typeof A.GetSelectedElements === 'function',
          hasGround : typeof A.ApplyGroundOffset  === 'function',
          hasNewDlt : typeof A.SetZDelta         === 'function' && typeof A.ApplyZDelta === 'function', // –¥–≤—É—Ö—à–∞–≥–æ–≤—ã–π
          hasOldDlt : typeof A.ApplyZDelta       === 'function' && A.ApplyZDelta.length >= 1            // –æ–¥–Ω–æ—Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–π
        };
      };
      const ready = () => {
        const caps = probe();
        return caps && (caps.hasSelect || caps.hasGround || caps.hasNewDlt || caps.hasOldDlt);
      };
      const fire = () => {
        if (fired) return;
        fired = true;
        try {
          const caps = probe();
          AddLog(`[UI] ACAPI –≥–æ—Ç–æ–≤: select=${!!caps.hasSelect} ground=${!!caps.hasGround} newŒî=${!!caps.hasNewDlt} oldŒî=${!!caps.hasOldDlt}`);
          cb();
        } catch (e) { AddLog('[UI] callback error: ' + e); }
      };

      if (ready()) { fire(); return; }

      let tries = 0;
      const maxTries = 120; // ~6 —Å–µ–∫
      const iv = setInterval(() => {
        if (ready()) {
          clearInterval(iv);
          fire();
        } else if (++tries > maxTries) {
          clearInterval(iv);
          AddLog('[UI] ACAPI —Ç–∞–∫ –∏ –Ω–µ –ø–æ—è–≤–∏–ª—Å—è (–ø—Ä–æ–≤–µ—Ä—å –∑–∞–≥—Ä—É–∑–∫—É –ø–∞–ª–∏—Ç—Ä—ã/–ø–ª–∞–≥–∏–Ω–∞)');
        }
      }, 50);
    }

    // =============== —Ç–∞–±–ª–∏—Ü–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è ===============
    function UpdateSelectedElements() {
      const A = window.ACAPI;
      if (!A || typeof A.GetSelectedElements !== 'function') {
        AddLog('[UI] ACAPI.GetSelectedElements –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        return;
      }
      A.GetSelectedElements().then(function (elemInfos) {
        const selectionTable = document.getElementById('selection');
        while (selectionTable.firstChild) selectionTable.removeChild(selectionTable.firstChild);

        if (!elemInfos || elemInfos.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="3">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤</td>';
          selectionTable.appendChild(tr);
          AddLog('[UI] –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø—É—Å—Ç–æ');
          return;
        }

        const grouped = {};
        for (let i = 0; i < elemInfos.length; i++) {
          const typeName = elemInfos[i][1];
          const elemID   = elemInfos[i][2];
          const key = typeName + "||" + elemID;
          if (!grouped[key]) grouped[key] = { type: typeName, id: elemID, count: 0 };
          grouped[key].count++;
        }
        Object.keys(grouped).forEach(key => {
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>' + grouped[key].type + '</td>' +
            '<td>' + grouped[key].id   + '</td>' +
            '<td>' + grouped[key].count+ '</td>';
          selectionTable.appendChild(tr);
        });
        AddLog('[UI] –í—ã–¥–µ–ª–µ–Ω–æ –≥—Ä—É–ø–ø: ' + Object.keys(grouped).length + ', —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ' + elemInfos.length);
      }).catch(err => AddLog('[UI] GetSelectedElements error: ' + err));
    }

    // =============== –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è/—Ä–∞—Å–∫–ª–∞–¥–∫–∞/–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ ===============
    function RotateSelection() {
      const s = document.getElementById('rotateAngle').value;
      if (window.ACAPI && typeof ACAPI.RotateSelected === 'function') ACAPI.RotateSelected(s);
      setInfo("info-orient", "–ü–æ–≤–µ—Ä–Ω—É–ª–∏ –Ω–∞ " + s + "¬∞");
    }
    function AlignSelectionX()         { if (ACAPI?.AlignSelectedX)         ACAPI.AlignSelectedX();         setInfo("info-orient", "–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ X"); }
    function RandomizeAngles()         { if (ACAPI?.RandomizeSelectedAngles) ACAPI.RandomizeSelectedAngles(); setInfo("info-orient", "–°–ª—É—á–∞–π–Ω—ã–π —É–≥–æ–ª –∑–∞–¥–∞–Ω"); }
    function OrientObjectsToPoint()    { if (ACAPI?.OrientObjectsToPoint)    ACAPI.OrientObjectsToPoint();    setInfo("info-orient", "–°–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Ç–æ—á–∫—É"); }
    function SetDistributionLine()     { if (ACAPI?.SetDistributionLine)     ACAPI.SetDistributionLine();     setInfo("info-dist","–õ–∏–Ω–∏—è –∑–∞–¥–∞–Ω–∞"); }
    function SetDistributionObject()   { if (ACAPI?.SetDistributionObject)   ACAPI.SetDistributionObject();   setInfo("info-dist","–û–±—ä–µ–∫—Ç –∑–∞–¥–∞–Ω"); }
    function SetDistributionStep () {
      const s = parseNumber(document.getElementById('distStep'), 0);
      const step = (isFinite(s) && s > 0) ? s : 0;
      if (ACAPI?.SetDistributionStep) ACAPI.SetDistributionStep(step);
      if (step > 0 && ACAPI?.DistributeNow) {
        const payload = "step:" + step;
        AddLog("[UI] Step OK ‚Üí " + payload);
        ACAPI.DistributeNow(payload).then(ok => setInfo("info-dist", ok ? "‚úî –†–∞–∑–ª–æ–∂–µ–Ω–æ –ø–æ —à–∞–≥—É" : "‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–∫–ª–∞–¥–∫–∏"));
      } else if (step <= 0) setInfo("info-dist", "–®–∞–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0");
    }
    function SetDistributionCount () {
      const c = parseInt((document.getElementById('distCount').value || "0"), 10);
      const count = (isFinite(c) && c > 0) ? c : 0;
      if (ACAPI?.SetDistributionCount) ACAPI.SetDistributionCount(count);
      if (count > 0 && ACAPI?.DistributeNow) {
        const payload = "count:" + count;
        AddLog("[UI] Count OK ‚Üí " + payload);
        ACAPI.DistributeNow(payload).then(ok => setInfo("info-dist", ok ? "‚úî –†–∞–∑–ª–æ–∂–µ–Ω–æ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É" : "‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–∫–ª–∞–¥–∫–∏"));
      } else if (count <= 0) setInfo("info-dist", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â• 1");
    }
    function CreateSlabAlongCurve(){
      const w = parseNumber(document.getElementById('slabWidth'), 0);
      if (ACAPI?.CreateSlabAlongCurve) ACAPI.CreateSlabAlongCurve(w);
      setInfo("info-build","–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ, —à–∏—Ä–∏–Ω–∞=" + w);
    }
    function CreateShellAlongCurve(){
      const w = parseNumber(document.getElementById('shellWidth'), 0);
      if (ACAPI?.CreateShellAlongCurve) ACAPI.CreateShellAlongCurve(w);
      setInfo("info-build","–û–±–æ–ª–æ—á–∫–∞, —à–∏—Ä–∏–Ω–∞=" + w);
    }
    function GenerateGDLFromSelection() {
      if (!ACAPI?.GenerateGDLFromSelection) { AddLog('[UI] ACAPI.GenerateGDLFromSelection –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
      ACAPI.GenerateGDLFromSelection().then(code => {
        document.getElementById('gdlOutput').value = code || "–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥–µ–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
      });
    }

    // ================= –†–ê–ó–ú–ï–¢–ö–ê =================
    function CreateMarkup() {
      const A = window.ACAPI;
      if (!A) { AddLog('[Markup] ACAPI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
      if (!A.SetMarkupStep || !A.CreateMarkupDimensions) {
        AddLog('[Markup] API —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
        setInfo('info-markup', '‚ùå –§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–æ–±–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω)');
        return;
      }

      const stepMM = parseNumber(document.getElementById('markupStep'), 1000);
      if (stepMM <= 0) {
        setInfo('info-markup', '–®–∞–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0');
        return;
      }

      AddLog('[Markup] –®–∞–≥ = ' + stepMM + ' –º–º');
      setInfo('info-markup', '–ó–∞–¥–∞–π—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä–∞–Ω–¥–∞—à–æ–º...');

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∞–≥ (–ø–µ—Ä–µ–¥–∞—ë–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É, –∫–∞–∫ –≤ SetZDelta!)
      const stepOk = A.SetMarkupStep(String(stepMM));
      AddLog('[Markup] SetMarkupStep –≤—ã–∑–≤–∞–Ω —Å: ' + stepMM + ' (as string)');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ Promise (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è async)
      Promise.resolve(stepOk).then(ok => {
        AddLog('[Markup] SetMarkupStep —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ' + ok);
        if (!ok) {
          setInfo('info-markup', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —à–∞–≥');
          return;
        }

        // –í—ã–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ç–∫—É (–±–ª–æ–∫–∏—Ä—É–µ—Ç UI, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏–Ω–∏—é)
        return A.CreateMarkupDimensions();
      }).then(created => {
        if (created) {
          setInfo('info-markup', '‚úî –†–∞–∑–º–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
          AddLog('[Markup] SUCCESS');
        } else {
          setInfo('info-markup', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É (—Å–º. –ª–æ–≥)');
          AddLog('[Markup] FAILED');
        }
      }).catch(e => {
        AddLog('[Markup] –û—à–∏–±–∫–∞: ' + e);
        setInfo('info-markup', '‚ùå –û—à–∏–±–∫–∞: ' + e);
      });
    }

    // ================= –ü–†–ò–ó–ï–ú–õ–ï–ù–ò–ï / –°–ú–ï–©–ï–ù–ò–ï =================
    // ŒîZ –ë–ï–ó MESH: SetGroundObjects + (–Ω–æ–≤—ã–π –∏–ª–∏ —Å—Ç–∞—Ä—ã–π) ApplyZDelta
    async function ApplyZDeltaUI() {
      const A = window.ACAPI;
      if (!A) { AddLog('[ZDelta] ACAPI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }

      const btn = document.getElementById('btnApplyOffset');
      btn?.setAttribute('disabled','disabled');

      const mm = parseNumber(document.getElementById('groundOffset'), 0);
      const meters = mm / 1000.0;
      AddLog('[ZDelta] ŒîZ = ' + mm + ' –º–º (' + meters + ' –º)');
      if (!isFinite(meters)) { setInfo('info-ground','–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–º–µ—â–µ–Ω–∏—è'); btn?.removeAttribute('disabled'); return; }
      if (Math.abs(meters) < 1e-9) AddLog('[ZDelta] WARNING: delta‚âà0 ‚Äî –≤–∏–∑—É–∞–ª—å–Ω–æ –º–æ–∂–µ—Ç –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è');

      try {
        const okObjs = await A.SetGroundObjects();
        AddLog('[ZDelta] SetGroundObjects ‚Üí ' + okObjs);
        if (!okObjs) { setInfo('info-ground','–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç—ã/–∫–æ–ª–æ–Ω–Ω—ã/—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏.'); return; }

        let applied = false;
        if (typeof A.SetZDelta === 'function' && typeof A.ApplyZDelta === 'function' && A.ApplyZDelta.length === 0) {
          // –ù–û–í–´–ô –ø—Ä–æ—Ç–æ–∫–æ–ª: —Å–Ω–∞—á–∞–ª–∞ –±—É—Ñ–µ—Ä–æ–º (—Å—Ç—Ä–æ–∫–æ–π), –ø–æ—Ç–æ–º –≤—ã–∑–æ–≤ –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞
          AddLog('[ZDelta] –ù–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª: SetZDelta(m as string) ‚Üí ApplyZDelta()');
          await A.SetZDelta(String(meters));
          applied = await A.ApplyZDelta();
        } else if (typeof A.ApplyZDelta === 'function') {
          // –°–¢–ê–†–´–ô –ø—Ä–æ—Ç–æ–∫–æ–ª: –µ–¥–∏–Ω—ã–π –≤—ã–∑–æ–≤ c —á–∏—Å–ª–æ–º
          AddLog('[ZDelta] –°—Ç–∞—Ä—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª: ApplyZDelta(m as number)');
          applied = await A.ApplyZDelta(meters);
        } else {
          throw new Error('ACAPI.ApplyZDelta –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        }

        setInfo('info-ground', applied ? '‚úî –°–º–µ—â–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (' + mm + ' –º–º)' : '‚ùå –û—à–∏–±–∫–∞ —Å–º–µ—â–µ–Ω–∏—è');
        AddLog('[ZDelta] Apply ‚Üí ' + applied);
        if (applied) UpdateSelectedElements();
      } catch (e) {
        AddLog('[ZDelta] –û—à–∏–±–∫–∞: ' + e);
        setInfo('info-ground','–û—à–∏–±–∫–∞ —Å–º–µ—â–µ–Ω–∏—è ‚Äî —Å–º. –ª–æ–≥');
      } finally {
        btn?.removeAttribute('disabled');
      }
    }

    // –ü–û–°–ê–î–ö–ê –ù–ê MESH: SetGroundSurface + SetGroundObjects + ApplyGroundOffset(0)
    async function LandToMeshUI() {
      const A = window.ACAPI;
      if (!A) { AddLog('[Ground] ACAPI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }

      const btnApply = document.getElementById('btnApplyOffset');
      const btnLand  = document.getElementById('btnLand');
      btnApply?.setAttribute('disabled','disabled');
      btnLand ?.setAttribute('disabled','disabled');
      setInfo('info-ground','–ü—Ä–∏–∑–µ–º–ª—è—é –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å‚Ä¶');

      try {
        const okSurf = await A.SetGroundSurface();
        AddLog('[Ground] SetGroundSurface ‚Üí ' + okSurf);
        if (!okSurf) { setInfo('info-ground','–í—ã–±–µ—Ä–∏—Ç–µ –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å (3D-—Å–µ—Ç–∫—É).'); return; }

        const okObjs = await A.SetGroundObjects();
        AddLog('[Ground] SetGroundObjects ‚Üí ' + okObjs);
        if (!okObjs) { setInfo('info-ground','–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç—ã/–∫–æ–ª–æ–Ω–Ω—ã/—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏.'); return; }

        const applied = await A.ApplyGroundOffset(0.0); // offset –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ C++
        AddLog('[Ground] ApplyGroundOffset(0) ‚Üí ' + applied);
        setInfo('info-ground', applied ? '‚úî –ü—Ä–∏–∑–µ–º–ª–µ–Ω–æ –Ω–∞ Mesh' : '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏—è');
        if (applied) UpdateSelectedElements();
      } catch (e) {
        AddLog('[Ground] –û—à–∏–±–∫–∞: ' + e);
        setInfo('info-ground','–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–∑–µ–º–ª–µ–Ω–∏–∏ ‚Äî —Å–º. –ª–æ–≥');
      } finally {
        btnApply?.removeAttribute('disabled');
        btnLand ?.removeAttribute('disabled');
      }
    }

    // ===== —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –º–æ—Å—Ç–æ–º (–Ω–µ –º–µ—à–∞—é—Ç —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ) =====
    function onShift(mm) {
      const m = parseFloat(mm) / 1000;
      AddLog(`[UI] Shift click, delta=${m} m`);
      if (window.ACAPI_Call) ACAPI_Call('ApplyZDelta', m);
    }
    function onLand() {
      AddLog(`[UI] Land click`);
      if (window.ACAPI_Call) ACAPI_Call('ApplyGroundOffset', 0.0);
    }

    // =============== –≤–∫–ª–∞–¥–∫–∏ / init ===============
    function openTab(evt, tabId) {
      const contents = document.getElementsByClassName("tabcontent");
      const links = document.getElementsByClassName("tablink");
      for (let i = 0; i < contents.length; i++) contents[i].style.display = "none";
      for (let i = 0; i < links.length; i++) links[i].classList.remove("active");
      const tab = document.getElementById(tabId);
      if (tab) tab.style.display = "block";
      evt.currentTarget.classList.add("active");
      AddLog('[UI] Tab ‚Üí ' + tabId);
    }
    window.openTab = openTab;

    window.addEventListener('DOMContentLoaded', function () {
      AddLog("[UI] Ready (UI v0.4)");

      // Enter-–Ω–∞–∂–∞—Ç–∏—è –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
      const step = document.getElementById('distStep');
      const cnt  = document.getElementById('distCount');
      step?.addEventListener('keydown', e => { if (e.key === 'Enter') SetDistributionStep(); });
      cnt ?.addEventListener('keydown',  e => { if (e.key === 'Enter') SetDistributionCount(); });

      // Enter –ø–æ —Å–º–µ—â–µ–Ω–∏—é ‚Äî –∫–∞–∫ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª (ŒîZ)
      const offset = document.getElementById('groundOffset');
      offset?.addEventListener('keydown', e => { if (e.key === 'Enter') whenACAPIReadyDo(ApplyZDeltaUI); });

      // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –ø–æ –ª—é–±—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º —Å data-help-url
      document.addEventListener('click', function (e) {
        const el = e.target.closest('[data-help-url]');
        if (!el) return;
        e.preventDefault();
        const url = el.getAttribute('data-help-url') || 'https://landscape.227.info/help/start';
        AddLog('[UI] help ‚Üí ' + url);

        const A = window.ACAPI;
        if (A && typeof A.OpenHelp === 'function') {
          Promise.resolve(A.OpenHelp(url))
            .then(() => AddLog('[UI] ACAPI.OpenHelp ok'))
            .catch(err => AddLog('[UI] ACAPI.OpenHelp error: ' + err));
        } else {
          AddLog('[UI] ACAPI.OpenHelp –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí window.open');
          window.open(url, '_blank', 'noopener,noreferrer');
        }
      });

      // –∂–¥—ë–º –º–æ—Å—Ç –∏ —Ç–æ–ª—å–∫–æ –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
      whenACAPIReadyDo(() => {
        UpdateSelectedElements();
      });

      // –≤–∫–ª–∞–¥–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      // const def = document.getElementById("defaultTab");
      // if (def) def.click();
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const distribTab = document.querySelector('button[onclick*="tab-distrib"]');
      if (distribTab) distribTab.click();
    });
  </script>
</head>

<body>
  <!-- –¢–∞–±–ª–∏—Ü–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è -->
  <table class="selection-table">
    <thead>
      <tr><th colspan="3">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:</th></tr>
      <tr><th>–¢–∏–ø</th><th>ID</th><th>–ö–æ–ª-–≤–æ</th></tr>
    </thead>
    <tbody id="selection"><tr><td colspan="3">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤</td></tr></tbody>
  </table>

  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="tabs">
    <!-- <button id="defaultTab" class="tablink" onclick="openTab(event,'tab-build')">–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ</button> -->
    <button class="tablink" onclick="openTab(event,'tab-distrib')">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</button>
    <button class="tablink" onclick="openTab(event,'tab-orient')">–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è</button>
    <button class="tablink" onclick="openTab(event,'tab-ground')">–ü—Ä–∏–∑–µ–º–ª–µ–Ω–∏–µ</button>
    <button class="tablink" onclick="openTab(event,'tab-markup')">–†–∞–∑–º–µ—Ç–∫–∞</button>
    <button class="tablink" onclick="openTab(event,'tab-gdl')">GDL</button>
  </div>

  <!-- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ -->
  <!--
  <div id="tab-build" class="tabcontent">
    <fieldset class="control-block">
      <legend>–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –ø–æ –ª–∏–Ω–∏–∏</legend>
      <div style="text-align:center; margin-bottom:6px;">
        <input type="button" onclick="ACAPI.SetCurveForSlab && ACAPI.SetCurveForSlab()" value="–í—ã–±—Ä–∞—Ç—å –ª–∏–Ω–∏—é">
      </div>
      <div>
        <label>–®–∏—Ä–∏–Ω–∞:</label>
        <input type="number" id="slabWidth" step="1" value="1000">
        <input type="button" onclick="CreateSlabAlongCurve()" value="–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ">
      </div>
    </fieldset>

    <fieldset class="control-block">
      <legend>–û–±–æ–ª–æ—á–∫–∞ –ø–æ –ª–∏–Ω–∏–∏</legend>
      <div style="text-align:center; margin-bottom:6px;">
        <input type="button" onclick="ACAPI.SetCurveForShell && ACAPI.SetCurveForShell()" value="–í—ã–±—Ä–∞—Ç—å –ª–∏–Ω–∏—é"><br><br>
        <input type="button" onclick="ACAPI.SetMeshForShell && ACAPI.SetMeshForShell()" value="–í—ã–±—Ä–∞—Ç—å 3D —Å–µ—Ç–∫—É">
      </div>
      <div>
        <label>–®–∏—Ä–∏–Ω–∞:</label>
        <input type="number" id="shellWidth" step="1" value="1000">
        <input type="button" onclick="CreateShellAlongCurve()" value="OK">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <input type="button" onclick="CreateShellAlongCurve()" value="–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –û–±–æ–ª–æ—á–∫—É">
      </div>
      <div id="info-build" class="info-box">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏–Ω–∏—é/—Å–µ—Ç–∫—É –∏ –∑–∞–¥–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/buildshell?embed=1"
            data-help-title="–°–ø—Ä–∞–≤–∫–∞: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ">–ü–æ–º–æ—â—å</button>
  </div>
  -->

  <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ -->
  <div id="tab-distrib" class="tabcontent">
    <fieldset class="control-block">
      <legend>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</legend>
      <div style="text-align:center;">
        <input type="button" onclick="SetDistributionLine()" value="–ó–∞–¥–∞—Ç—å –ª–∏–Ω–∏—é"><br><br>
        <input type="button" onclick="SetDistributionObject()" value="–ó–∞–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç">
      </div>
      <div>
        <label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</label>
        <input type="number" id="distStep" step="1" value="0">
        <input type="button" onclick="SetDistributionStep()" value="OK">
      </div>
      <div>
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
        <input type="number" id="distCount" step="1" value="1">
        <input type="button" onclick="SetDistributionCount()" value="OK">
      </div>
      <div id="info-dist" class="info-box">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∑–∞–¥–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/distribution?embed=1"
            data-help-title="–°–ø—Ä–∞–≤–∫–∞: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ">–ü–æ–º–æ—â—å</button>
  </div>

  <!-- –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è -->
  <div id="tab-orient" class="tabcontent">
    <fieldset class="control-block">
      <legend>–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è</legend>
      <div>
        <label>–£–≥–æ–ª:</label>
        <input type="number" id="rotateAngle" step="1" value="0">
        <input type="button" onclick="RotateSelection()" value="–ü–æ–≤–µ—Ä–Ω—É—Ç—å">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <input type="button" onclick="AlignSelectionX()" value="–í—ã—Ä–æ–≤–Ω—è—Ç—å –ø–æ X"><br><br>
        <input type="button" onclick="RandomizeAngles()" value="–°–ª—É—á–∞–π–Ω—ã–π —É–≥–æ–ª (0-360)"><br><br>
        <input type="button" onclick="OrientObjectsToPoint()" value="–°–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ç–æ—á–∫—É">
      </div>
      <div id="info-orient" class="info-box">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∑–∞–¥–∞–π—Ç–µ —É–≥–æ–ª –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/orientation?embed=1"
            data-help-title="–°–ø—Ä–∞–≤–∫–∞: –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è">–ü–æ–º–æ—â—å</button>
  </div>

  <!-- –ü—Ä–∏–∑–µ–º–ª–µ–Ω–∏–µ -->
  <div id="tab-ground" class="tabcontent">
    <fieldset class="control-block">
      <legend>–ü—Ä–∏–∑–µ–º–ª–µ–Ω–∏–µ</legend>

      <div style="text-align:center; margin-bottom:10px;">
        <label>–°–º–µ—â–µ–Ω–∏–µ Z (–º–º):</label>
        <input type="number" id="groundOffset" step="1" value="0">
        <!-- –ü—Ä–∏–º–µ–Ω–∏—Ç—å = ŒîZ -->
        <input id="btnApplyOffset" type="button" onclick="whenACAPIReadyDo(ApplyZDeltaUI)" value="–ü—Ä–∏–º–µ–Ω–∏—Ç—å">
      </div>

      <div style="text-align:center;">
        <!-- –ü—Ä–∏–∑–µ–º–ª–∏—Ç—å = –ø–æ—Å–∞–¥–∫–∞ –Ω–∞ mesh -->
        <input id="btnLand" type="button" onclick="whenACAPIReadyDo(LandToMeshUI)" value="–ü—Ä–∏–∑–µ–º–ª–∏—Ç—å">
      </div>

      <div id="info-ground" class="info-box">
        –†–µ–∂–∏–º—ã: ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–¥–≤–∏–≥ –ø–æ Z (–±–µ–∑ mesh). ¬´–ü—Ä–∏–∑–µ–º–ª–∏—Ç—å¬ª ‚Äî –ø–æ—Å–∞–¥–∫–∞ –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é 3D-—Å–µ—Ç–∫—É (—Å–º–µ—â–µ–Ω–∏–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è).
      </div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/ground?embed=1"
            data-help-title="–°–ø—Ä–∞–≤–∫–∞: –ü—Ä–∏–∑–µ–º–ª–µ–Ω–∏–µ">–ü–æ–º–æ—â—å</button>
  </div>

  <!-- –†–∞–∑–º–µ—Ç–∫–∞ -->
  <div id="tab-markup" class="tabcontent">
    <fieldset class="control-block">
      <legend>–†–∞–∑–º–µ—Ç–∫–∞ —Ä–∞–∑–º–µ—Ä–∞–º–∏</legend>

      <div style="text-align:center; margin-bottom:10px;">
        <p style="font-size:12px; color:#666;">
          1. –í—ã–¥–µ–ª–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã (Mesh/Slab/Wall/Shell)<br>
          2. –ó–∞–¥–∞–π—Ç–µ —à–∞–≥<br>
          3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ <b>2 —Ç–æ—á–∫–∏</b> –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        </p>
      </div>

      <div>
        <label>–®–∞–≥ —Ä–∞–∑–º–µ—Ç–∫–∏ (–º–º):</label>
        <input type="number" id="markupStep" step="1" value="1000">
      </div>

      <div style="text-align:center; margin-top:15px;">
        <input type="button" 
               onclick="CreateMarkup()" 
               value="üìè –†–∞–∑–º–µ—Ç–∏—Ç—å"
               style="font-size:16px; padding:8px 20px; font-weight:bold;">
      </div>

      <div id="info-markup" class="info-box">
        –°–æ–∑–¥–∞—ë—Ç —Ä–∞–∑–º–µ—Ä—ã –®–ò–†–ò–ù–´ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é.<br>
        –õ–∏–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –æ–±—è–∑–∞–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ —ç–ª–µ–º–µ–Ω—Ç - –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —Å–±–æ–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–¥–æ–ª—å –∑–∞–±–æ—Ä–∞).
      </div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/markup?embed=1"
            data-help-title="–°–ø—Ä–∞–≤–∫–∞: –†–∞–∑–º–µ—Ç–∫–∞">–ü–æ–º–æ—â—å</button>
  </div>

  <!-- GDL -->
  <div id="tab-gdl" class="tabcontent">
    <fieldset class="control-block">
      <legend>GDL-–∫–æ–¥ –∏–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è</legend>
      <div style="text-align:center;">
        <input type="button" onclick="GenerateGDLFromSelection()" value="–°–æ–∑–¥–∞—Ç—å GDL">
      </div>
      <textarea id="gdlOutput" style="width:95%;height:200px;margin-top:10px;font-family:monospace;"></textarea>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/gdl?embed=1"
            data-help-title="–°–ø—Ä–∞–≤–∫–∞: GDL">–ü–æ–º–æ—â—å</button>
  </div>

  <div id="log-box">[–õ–æ–≥ –ø–ª–∞–≥–∏–Ω–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å]</div>

  <a href="#"
     data-help-url="https://landscape.227.info/?embed=1"
     data-help-title="LandscapeHelper ‚Äî —Å–∞–π—Ç">
    landscape.227.info
  </a>
</body>
</html>

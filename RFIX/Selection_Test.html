<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Landscape REPL</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:20px; }
    
    /* LANDSCAPE HELPER Logo */
    .logo-container { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      margin: 0 auto 25px; 
      padding: 20px 25px; 
      background: linear-gradient(135deg, #f5f3ee 0%, #ebe8e0 100%);
      border: 1px solid #d4d0c7;
      border-radius: 12px; 
      box-shadow: 0 6px 20px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.04);
      max-width: 650px;
      position: relative;
      overflow: hidden;
    }
    .logo-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 20%, rgba(79, 96, 79, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(110, 128, 110, 0.03) 0%, transparent 50%);
      pointer-events: none;
    }
    .logo-icon { 
      width: 70px; 
      height: 70px; 
      background: #4F604F;
      border: 2px solid #4F604F;
      border-radius: 12px;
      position: relative;
      margin-right: 20px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .logo-icon::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #6E806E 0%, #6E806E 45%, #4F604F 45%, #4F604F 100%);
      border-radius: 10px;
    }
    .logo-icon::after {
      content: '';
      position: absolute;
      top: 12px;
      left: 12px;
      width: 16px;
      height: 16px;
      background: #6E806E;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .logo-icon .mountain {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 18px solid #6E806E;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .logo-text { 
      color: #4F604F; 
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      font-weight: 700;
      text-align: left;
      position: relative;
      z-index: 1;
    }
    .logo-title { 
      font-size: 28px; 
      line-height: 1.0; 
      margin: 0; 
      letter-spacing: 1.2px;
      font-family: 'Segoe UI', Arial, sans-serif;
      text-transform: uppercase;
    }
    .logo-subtitle { 
      font-size: 13px; 
      margin: 4px 0 0 0; 
      letter-spacing: 0.8px;
      opacity: 0.85;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    table.selection-table { border-collapse:collapse; margin:0 auto 20px; width:80%; max-width:800px; background:#fff; }
    table.selection-table th, table.selection-table td { border:1px solid #888; padding:6px 10px; text-align:center; }
    table.selection-table thead { background:#f0f0f0; font-weight:bold; }
    .tabs { text-align:center; margin-bottom:10px; }
    .tablink { display:inline-block; padding:8px 16px; margin:0 4px; border:0; border-radius:4px 4px 0 0; background:#ddd; cursor:pointer; font-size:14px; }
    .tablink.active { background:#366536; color:#fff; }
    .tabcontent { display:none; position:relative; }
    fieldset.control-block { display:block; margin:15px auto; padding:15px; width:400px; max-width:95%; border:1px solid #aaa; border-radius:6px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    fieldset.control-block legend { font-weight:bold; }
    fieldset.control-block label { display:inline-block; width:140px; text-align:right; margin-right:8px; }
    fieldset.control-block input[type="number"] { width:120px; padding:3px; margin:3px 0; }
    fieldset.control-block input[type="button"] { margin:4px 0; padding:4px 10px; cursor:pointer; }
    .info-box { margin-top:10px; padding:6px; background:#f9f9f9; border:1px dashed #aaa; font-size:12px; min-height:30px; white-space:pre-wrap; }
    a { display:block; text-align:center; margin-top:20px; }
    .tab-help { position:absolute; right:10px; bottom:10px; padding:8px 12px; border:0; border-radius:8px; background:#366536; color:#fff; font-weight:600; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.2); }
    .tab-help:hover { filter:brightness(1.05); }
    .tab-help:active { transform:translateY(1px); }
    #log-box { margin-top:10px; padding:8px; background:#111; color:#0f0; font-family:monospace; font-size:12px; height:140px; overflow:auto; }
    .muted { opacity:.6; }
  </style>

  <script type="text/javascript">
    "use strict";

    // ================= helpers =================
    function AddLog(msg) {
      const box = document.getElementById('log-box');
      if (!box) return;
      const now = new Date().toLocaleTimeString();
      box.textContent += "\n[" + now + "] " + msg;
      box.scrollTop = box.scrollHeight;
    }
    
    function setInfo(id, msg) {
      const el = document.getElementById(id);
      if (el) el.textContent = msg;
    }
    function parseNumber(inputEl, def = 0) {
      let v = (typeof inputEl.valueAsNumber === 'number' && !isNaN(inputEl.valueAsNumber)) ? inputEl.valueAsNumber : NaN;
      if (isNaN(v)) {
        const p = parseFloat(String(inputEl.value || "").replace(',', '.'));
        v = Number.isFinite(p) ? p : def;
      }
      return v;
    }

    // Глобальная переменная для хранения последнего установленного шага разметки
    let g_lastMarkupStepMm = 2500; // значение по умолчанию

    // =============== ACAPI bridge waiting (with diagnostics) ===============
    function whenACAPIReadyDo(cb) {
      let fired = false;
      const probe = () => {
        const A = window.ACAPI;
        if (!A) return null;
        return {
          hasSelect : typeof A.GetSelectedElements === 'function',
          hasGround : typeof A.ApplyGroundOffset  === 'function',
          hasNewDlt : typeof A.SetZDelta         === 'function' && typeof A.ApplyZDelta === 'function',
          hasOldDlt : typeof A.ApplyZDelta       === 'function' && A.ApplyZDelta.length >= 1
        };
      };
      const ready = () => {
        const caps = probe();
        return caps && (caps.hasSelect || caps.hasGround || caps.hasNewDlt || caps.hasOldDlt);
      };
      const fire = () => {
        if (fired) return;
        fired = true;
        try {
          const caps = probe();
          AddLog(`[UI] ACAPI ready: select=${!!caps.hasSelect} ground=${!!caps.hasGround} newΔ=${!!caps.hasNewDlt} oldΔ=${!!caps.hasOldDlt}`);
          cb();
        } catch (e) { AddLog('[UI] callback error: ' + e); }
      };

      if (ready()) { fire(); return; }

      let tries = 0;
      const maxTries = 120;
      const iv = setInterval(() => {
        if (ready()) {
          clearInterval(iv);
          fire();
        } else if (++tries > maxTries) {
          clearInterval(iv);
          AddLog('[UI] ACAPI never appeared (check palette/plugin loading)');
        }
      }, 50);
    }

    // =============== selection table ===============
    function UpdateSelectedElements() {
      const A = window.ACAPI;
      if (!A || typeof A.GetSelectedElements !== 'function') {
        AddLog('[UI] ACAPI.GetSelectedElements unavailable');
        return;
      }
      A.GetSelectedElements().then(function (elemInfos) {
        const selectionTable = document.getElementById('selection');
        while (selectionTable.firstChild) selectionTable.removeChild(selectionTable.firstChild);

        AddLog('[UI] GetSelectedElements returned: ' + JSON.stringify(elemInfos));
        AddLog('[UI] Data type: ' + typeof elemInfos + ', length: ' + (elemInfos ? elemInfos.length : 'undefined'));

        if (!elemInfos || elemInfos.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="4">No selected elements</td>';
          selectionTable.appendChild(tr);
          AddLog('[UI] Selection is empty');
          return;
        }

        const grouped = {};
        for (let i = 0; i < elemInfos.length; i++) {
          AddLog('[UI] Element ' + i + ': ' + JSON.stringify(elemInfos[i]));
          
          const typeName  = elemInfos[i][1];
          const elemID    = elemInfos[i][2];
          const layerName = elemInfos[i][3] || 'Unknown';
          
          AddLog('[UI] Parsing: typeName=' + typeName + ', elemID=' + elemID + ', layerName=' + layerName);
          
          const key = typeName + "||" + elemID + "||" + layerName;
          if (!grouped[key]) grouped[key] = { type: typeName, id: elemID, layer: layerName, count: 0 };
          grouped[key].count++;
        }
        Object.keys(grouped).forEach(key => {
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>' + grouped[key].type  + '</td>' +
            '<td>' + grouped[key].id    + '</td>' +
            '<td>' + grouped[key].layer + '</td>' +
            '<td>' + grouped[key].count + '</td>';
          selectionTable.appendChild(tr);
        });
        AddLog('[UI] Selected groups: ' + Object.keys(grouped).length + ', elements: ' + elemInfos.length);
      }).catch(err => AddLog('[UI] GetSelectedElements error: ' + err));
    }

    // =============== ID renaming (bulk, without layers) ===============
    function changeAllSelectedIDs() {
      const A = window.ACAPI;
      if (!A || typeof A.ChangeSelectedElementsID !== 'function') {
        AddLog('[UI] ACAPI.ChangeSelectedElementsID unavailable');
        return;
      }
      
      const baseID = document.getElementById('baseID').value.trim();
      if (!baseID) {
        AddLog('[UI] Enter base name for element IDs');
        document.getElementById('baseID').focus();
        return;
      }
      
      AddLog('[UI] Changing element IDs with base name: ' + baseID);
      
      A.ChangeSelectedElementsID(baseID).then(function(success) {
        if (success) {
          AddLog('[UI] ✅ All selected element IDs successfully changed!');
          setInfo("id-change-info", "✅ IDs changed! Examples: " + baseID + "-01, " + baseID + "-02, " + baseID + "-03...");
          document.getElementById('baseID').value = '';
          setTimeout(UpdateSelectedElements, 1000);
        } else {
          AddLog('[UI] ❌ Error changing element IDs');
          setInfo("id-change-info", "❌ Error! Possibly no selected elements or element doesn't support ID change");
        }
      }).catch(function(err) {
        AddLog('[UI] ❌ Error calling ChangeSelectedElementsID: ' + err);
        setInfo("id-change-info", "❌ Error: " + err);
      });
    }

    // =============== folder/layer creation + move + ID ===============
    function createLayerAndMoveElements() {
      const A = window.ACAPI;
      if (!A) {
        AddLog('[UI] ACAPI unavailable');
        return;
      }

      const folderPath = document.getElementById('layerFolder').value.trim();
      const layerName  = document.getElementById('layerName').value.trim();

      if (!folderPath) {
        AddLog('[UI] Введите путь к папке для слоев');
        document.getElementById('layerFolder').focus();
        return;
      }
      if (!layerName) {
        AddLog('[UI] Введите название слоя');
        document.getElementById('layerName').focus();
        return;
      }

      AddLog('[UI] Создание папки: ' + folderPath + ', слоя: ' + layerName);
      setInfo("info-layers", "Создание папки, слоя и перенос выделенных элементов...");

      if (typeof A.CreateLayerAndMoveElements === 'function') {
        // мост ждёт folder|layer (без baseID)
        const params = folderPath + '|' + layerName;

        AddLog('[JS] CreateLayerAndMoveElements');
        AddLog('[JS] Параметры: ' + params);
        
        A.CreateLayerAndMoveElements(params).then(function(success) {
          AddLog('[JS] CreateLayerAndMoveElements вернул: ' + success);
          if (success) {
            AddLog('[UI] ✅ Папка/слой созданы, элементы перенесены!');
            setInfo("info-layers", "✅ Успешно! Папка: " + folderPath + ", Слой: " + layerName);
            document.getElementById('layerFolder').value  = '';
            document.getElementById('layerName').value    = '';
            setTimeout(UpdateSelectedElements, 1000);
          } else {
            AddLog('[UI] ❌ Ошибка при создании папки/слоя или переносе элементов');
            setInfo("info-layers", "❌ Ошибка! Проверьте правильность введенных данных / выделение");
          }
        }).catch(function(err) {
          AddLog('[UI] ❌ Ошибка вызова CreateLayerAndMoveElements: ' + err);
          setInfo("info-layers", "❌ Ошибка: " + err);
        });
      } else {
        AddLog('[UI] ❌ Функция CreateLayerAndMoveElements недоступна');
        setInfo("info-layers", "❌ Функция недоступна (обновите плагин)");
      }
    }

    // =============== orientation/distribution/... ===============
    function RotateSelection() {
      const s = document.getElementById('rotateAngle').value;
      if (window.ACAPI && typeof ACAPI.RotateSelected === 'function') ACAPI.RotateSelected(s);
      setInfo("info-orient", "Повернули на " + s + "°");
    }
    function AlignSelectionX()         { if (ACAPI?.AlignSelectedX)         ACAPI.AlignSelectedX();         setInfo("info-orient", "Выравнивание по X"); }
    function RandomizeAngles()         { if (ACAPI?.RandomizeSelectedAngles) ACAPI.RandomizeSelectedAngles(); setInfo("info-orient", "Случайный угол задан"); }
    function OrientObjectsToPoint()    { if (ACAPI?.OrientObjectsToPoint)    ACAPI.OrientObjectsToPoint();    setInfo("info-orient", "Сориентированы на точку"); }
    function SetDistributionLine()     { if (ACAPI?.SetDistributionLine)     ACAPI.SetDistributionLine();     setInfo("info-dist","Линия задана"); }
    function SetDistributionObject()   { if (ACAPI?.SetDistributionObject)   ACAPI.SetDistributionObject();   setInfo("info-dist","Объект задан"); }
    function SetDistributionStep () {
      const s = parseNumber(document.getElementById('distStep'), 0);
      const step = (isFinite(s) && s > 0) ? s : 0;
      if (ACAPI?.SetDistributionStep) ACAPI.SetDistributionStep(step);
      if (step > 0 && ACAPI?.DistributeNow) {
        const payload = "step:" + step;
        AddLog("[UI] Step OK → " + payload);
        ACAPI.DistributeNow(payload).then(ok => setInfo("info-dist", ok ? " Разложено по шагу" : " Ошибка раскладки"));
      } else if (step <= 0) setInfo("info-dist", "Шаг должен быть > 0");
    }
    function SetDistributionCount () {
      const c = parseInt((document.getElementById('distCount').value || "0"), 10);
      const count = (isFinite(c) && c > 0) ? c : 0;
      if (ACAPI?.SetDistributionCount) ACAPI.SetDistributionCount(count);
      if (count > 0 && ACAPI?.DistributeNow) {
        const payload = "count:" + count;
        AddLog("[UI] Count OK → " + payload);
        ACAPI.DistributeNow(payload).then(ok => setInfo("info-dist", ok ? " Разложено по количеству" : " Ошибка раскладки"));
      } else if (count <= 0) setInfo("info-dist", "Количество должно быть ≥ 1");
    }

    // ================= SHELL / CONTOURS =================
    function SelectBaseLine() {
      const A = window.ACAPI;
      if (!A) { AddLog('[Shell] ACAPI недоступен'); return; }
      if (!A.SetBaseLineForShell) {
        AddLog('[Shell] API функция SetBaseLineForShell недоступна');
        setInfo('info-shell', ' Функция недоступна (обновите плагин)');
        return;
      }

      AddLog('[Shell] Выбор базовой линии...');
      setInfo('info-shell', 'Выберите базовую линию (spline/polyline/дуга/линия)...');

      Promise.resolve(A.SetBaseLineForShell()).then(success => {
        if (success) {
          setInfo('info-shell', ' ✅ Базовая линия выбрана!');
          AddLog('[Shell] Базовая линия выбрана');
        } else {
          setInfo('info-shell', ' ❌ Не удалось выбрать линию');
          AddLog('[Shell] Ошибка выбора линии');
        }
      }).catch(e => {
        AddLog('[Shell] Ошибка: ' + e);
        setInfo('info-shell', ' ❌ Ошибка: ' + e);
      });
    }

    function CreateShellFromLine() {
      const A = window.ACAPI;
      if (!A) { AddLog('[Shell] ACAPI недоступен'); return; }
      if (!A.CreateShellFromLine) {
        AddLog('[Shell] API функция недоступна');
        setInfo('info-shell', ' Функция недоступна (обновите плагин)');
        return;
      }

      const width = parseNumber(document.getElementById('shellWidth'), 1000);
      const step  = parseNumber(document.getElementById('shellStep'), 500);
      
      if (width <= 0) {
        setInfo('info-shell', 'Ширина должна быть > 0');
        return;
      }
      if (step <= 0) {
        setInfo('info-shell', 'Шаг должен быть > 0');
        return;
      }

      AddLog('[Shell] Создание оболочки: ширина=' + width + 'мм, шаг=' + step + 'мм');
      setInfo('info-shell', 'Создание оболочки...');

      const params = "width:" + width + ",step:" + step;
      AddLog('[Shell] Вызов ACAPI.CreateShellFromLine с параметрами: ' + params);
      Promise.resolve(A.CreateShellFromLine(params)).then(success => {
        if (success) {
          setInfo('info-shell', ' ✅ Оболочка создана!');
          AddLog('[Shell] SUCCESS');
        } else {
          setInfo('info-shell', ' ❌ Не удалось создать оболочку');
          AddLog('[Shell] FAILED');
        }
      }).catch(e => {
        AddLog('[Shell] Ошибка: ' + e);
        setInfo('info-shell', ' ❌ Ошибка: ' + e);
      });
    }

    // ================= MARKUP/DIMENSIONS =================
    async function SetMarkupStepUI() {
      AddLog('[UI] DEBUG: SetMarkupStepUI called');
      const A = window.ACAPI;
      if (!A) {
        AddLog('[UI] ACAPI unavailable');
        return;
      }

      const stepInput = document.getElementById('markupStep');
      AddLog('[UI] DEBUG: stepInput = ' + stepInput);
      const stepStr = stepInput.value;
      AddLog('[UI] DEBUG: stepStr = "' + stepStr + '"');
      AddLog('[UI] DEBUG: stepInput.value = "' + stepInput.value + '"');
      AddLog('[UI] DEBUG: stepInput.defaultValue = "' + stepInput.defaultValue + '"');
      AddLog('[UI] DEBUG: stepInput.type = "' + stepInput.type + '"');
      AddLog('[UI] DEBUG: stepInput.id = "' + stepInput.id + '"');
      const stepMm = parseFloat(stepStr);
      AddLog('[UI] DEBUG: stepMm = ' + stepMm);
      
      // Принудительно преобразуем в число
      const stepMmNumber = Number(stepStr);
      AddLog('[UI] DEBUG: stepMmNumber = ' + stepMmNumber);
      
      if (isNaN(stepMm) || stepMm <= 0) {
        AddLog('[UI] Неверное значение шага разметки');
        setInfo("info-markup", "❌ Неверное значение шага разметки");
        return;
      }

      AddLog('[UI] Установка шага разметки: ' + stepMm + ' мм');
      AddLog('[UI] DEBUG: stepMm type = ' + typeof stepMm);
      AddLog('[UI] DEBUG: stepMm isNaN = ' + isNaN(stepMm));
      AddLog('[UI] DEBUG: stepMm === 0 = ' + (stepMm === 0));
      setInfo("info-markup", "Установка шага разметки...");

      if (typeof A.SetMarkupStep === 'function') {
        try {
          AddLog('[UI] DEBUG: Calling A.SetMarkupStep(' + stepMmNumber + ')');
          AddLog('[UI] DEBUG: stepMmNumber type=' + typeof stepMmNumber + ', value=' + stepMmNumber);
          // Принудительно преобразуем в строку, чтобы избежать INTEGER
          const success = await A.SetMarkupStep(stepMmNumber.toString());
          if (success) {
            // Сохраняем установленное значение в глобальную переменную
            g_lastMarkupStepMm = stepMmNumber;
            AddLog('[UI] ✅ Шаг разметки установлен: ' + stepMmNumber + ' мм');
            setInfo("info-markup", "✅ Шаг разметки установлен: " + stepMmNumber + " мм");
          } else {
            AddLog('[UI] ❌ Ошибка установки шага разметки');
            setInfo("info-markup", "❌ Ошибка установки шага разметки");
          }
        } catch (err) {
          AddLog('[UI] ❌ Ошибка вызова SetMarkupStep: ' + err);
          setInfo("info-markup", "❌ Ошибка: " + err);
        }
      } else {
        AddLog('[UI] ❌ Функция SetMarkupStep недоступна');
        setInfo("info-markup", "❌ Функция недоступна (обновите плагин)");
      }
    }

    async function CreateMarkupUI() {
      const A = window.ACAPI;
      if (!A) {
        AddLog('[UI] ACAPI unavailable');
        return;
      }

      // Используем сохраненное значение шага (если пользователь нажимал "Set")
      // или читаем из поля, если шаг еще не был установлен
      let stepMm = g_lastMarkupStepMm;
      
      // Если шаг не был установлен через "Set", читаем из поля
      if (g_lastMarkupStepMm === 2500) { // значение по умолчанию
        const stepInput = document.getElementById('markupStep');
        const stepStr = stepInput.value;
        const fieldStepMm = parseFloat(stepStr);
        
        if (!isNaN(fieldStepMm) && fieldStepMm > 0) {
          stepMm = fieldStepMm;
          AddLog('[UI] Используем значение из поля: ' + stepMm + ' мм');
        }
      } else {
        AddLog('[UI] Используем установленный шаг: ' + stepMm + ' мм');
      }
      
      // Устанавливаем шаг
      AddLog('[UI] Установка шага: ' + stepMm + ' мм');
      try {
        const stepSuccess = await A.SetMarkupStep(stepMm.toString());
        if (stepSuccess) {
          g_lastMarkupStepMm = stepMm; // обновляем сохраненное значение
          AddLog('[UI] ✅ Шаг установлен: ' + stepMm + ' мм');
        } else {
          AddLog('[UI] ❌ Ошибка установки шага');
          setInfo("info-markup", "❌ Ошибка установки шага");
          return;
        }
      } catch (err) {
        AddLog('[UI] ❌ Ошибка установки шага: ' + err);
        setInfo("info-markup", "❌ Ошибка установки шага");
        return;
      }

      AddLog('[UI] Создание разметки');
      setInfo("info-markup", "Создание разметки...");

      if (typeof A.CreateMarkupDimensions === 'function') {
        try {
          const success = await A.CreateMarkupDimensions();
          if (success) {
            AddLog('[UI] ✅ Разметка создана успешно');
            setInfo("info-markup", "✅ Разметка создана успешно");
          } else {
            AddLog('[UI] ❌ Ошибка создания разметки');
            setInfo("info-markup", "❌ Ошибка создания разметки");
          }
        } catch (err) {
          AddLog('[UI] ❌ Ошибка вызова CreateMarkupDimensions: ' + err);
          setInfo("info-markup", "❌ Ошибка: " + err);
        }
      } else {
        AddLog('[UI] ❌ Функция CreateMarkupDimensions недоступна');
        setInfo("info-markup", "❌ Функция недоступна (обновите плагин)");
      }
    }

    async function CreateDimensionsToLineUI() {
      const A = window.ACAPI;
      if (!A) {
        AddLog('[UI] ACAPI unavailable');
        return;
      }

      AddLog('[UI] Создание размеров к линии');
      setInfo("info-markup", "Создание размеров к линии...");

      if (typeof A.CreateDimensionsToLine === 'function') {
        try {
          const success = await A.CreateDimensionsToLine();
          if (success) {
            AddLog('[UI] ✅ Размеры к линии созданы успешно');
            setInfo("info-markup", "✅ Размеры к линии созданы успешно");
          } else {
            AddLog('[UI] ❌ Ошибка создания размеров к линии');
            setInfo("info-markup", "❌ Ошибка создания размеров к линии");
          }
        } catch (err) {
          AddLog('[UI] ❌ Ошибка вызова CreateDimensionsToLine: ' + err);
          setInfo("info-markup", "❌ Ошибка: " + err);
        }
      } else {
        AddLog('[UI] ❌ Функция CreateDimensionsToLine недоступна');
        setInfo("info-markup", "❌ Функция недоступна (обновите плагин)");
      }
    }

    async function CreateDimensionsBetweenUI() {
      const A = window.ACAPI;
      if (!A) {
        AddLog('[UI] ACAPI unavailable');
        return;
      }

      AddLog('[UI] Создание размеров между объектами');
      setInfo("info-markup", "Создание размеров между объектами...");

      if (typeof A.CreateDimensionsBetweenObjects === 'function') {
        try {
          const success = await A.CreateDimensionsBetweenObjects();
          if (success) {
            AddLog('[UI] ✅ Размеры между объектами созданы успешно');
            setInfo("info-markup", "✅ Размеры между объектами созданы успешно");
          } else {
            AddLog('[UI] ❌ Ошибка создания размеров между объектами');
            setInfo("info-markup", "❌ Ошибка создания размеров между объектами");
          }
        } catch (err) {
          AddLog('[UI] ❌ Ошибка вызова CreateDimensionsBetweenObjects: ' + err);
          setInfo("info-markup", "❌ Ошибка: " + err);
        }
      } else {
        AddLog('[UI] ❌ Функция CreateDimensionsBetweenObjects недоступна');
        setInfo("info-markup", "❌ Функция недоступна (обновите плагин)");
      }
    }

    async function CreateDimensionsToPointUI() {
      const A = window.ACAPI;
      if (!A) {
        AddLog('[UI] ACAPI unavailable');
        return;
      }

      AddLog('[UI] Создание размеров к точке');
      setInfo("info-markup", "Создание размеров к точке...");

      if (typeof A.CreateDimensionsToPoint === 'function') {
        try {
          const success = await A.CreateDimensionsToPoint();
          if (success) {
            AddLog('[UI] ✅ Размеры к точке созданы успешно');
            setInfo("info-markup", "✅ Размеры к точке созданы успешно");
          } else {
            AddLog('[UI] ❌ Ошибка создания размеров к точке');
            setInfo("info-markup", "❌ Ошибка создания размеров к точке");
          }
        } catch (err) {
          AddLog('[UI] ❌ Ошибка вызова CreateDimensionsToPoint: ' + err);
          setInfo("info-markup", "❌ Ошибка: " + err);
        }
      } else {
        AddLog('[UI] ❌ Функция CreateDimensionsToPoint недоступна');
        setInfo("info-markup", "❌ Функция недоступна (обновите плагин)");
      }
    }

    // ================= GROUNDING / OFFSET =================
    async function SetGroundSurfaceUI() {
      const A = window.ACAPI;
      if (!A) {
        AddLog('[UI] ACAPI unavailable');
        return;
      }

      AddLog('[UI] Выбор 3D-сетки для приземления');
      setInfo("info-ground", "Выбор 3D-сетки...");

      if (typeof A.SetGroundSurface === 'function') {
        try {
          const success = await A.SetGroundSurface();
          if (success) {
            AddLog('[UI] ✅ 3D-сетка выбрана успешно');
            setInfo("info-ground", "✅ 3D-сетка выбрана. Теперь выберите объекты и нажмите 'Приземлить'");
          } else {
            AddLog('[UI] ❌ Ошибка выбора 3D-сетки');
            setInfo("info-ground", "❌ Ошибка выбора 3D-сетки");
          }
        } catch (err) {
          AddLog('[UI] ❌ Ошибка вызова SetGroundSurface: ' + err);
          setInfo("info-ground", "❌ Ошибка: " + err);
        }
      } else {
        AddLog('[UI] ❌ Функция SetGroundSurface недоступна');
        setInfo("info-ground", "❌ Функция недоступна (обновите плагин)");
      }
    }

    async function SetGroundObjectsUI() {
      const A = window.ACAPI;
      if (!A) {
        AddLog('[UI] ACAPI unavailable');
        return;
      }

      AddLog('[UI] Выбор объектов для приземления');
      setInfo("info-ground", "Выбор объектов...");

      if (typeof A.SetGroundObjects === 'function') {
        try {
          const success = await A.SetGroundObjects();
          if (success) {
            AddLog('[UI] ✅ Объекты выбраны успешно');
            setInfo("info-ground", "✅ Объекты выбраны. Теперь нажмите 'Приземлить'");
          } else {
            AddLog('[UI] ❌ Ошибка выбора объектов');
            setInfo("info-ground", "❌ Ошибка выбора объектов");
          }
        } catch (err) {
          AddLog('[UI] ❌ Ошибка вызова SetGroundObjects: ' + err);
          setInfo("info-ground", "❌ Ошибка: " + err);
        }
      } else {
        AddLog('[UI] ❌ Функция SetGroundObjects недоступна');
        setInfo("info-ground", "❌ Функция недоступна (обновите плагин)");
      }
    }

    async function ApplyZDeltaUI() {
  AddLog('[UI] ===== ApplyZDeltaUI START =====');
  const A = window.ACAPI;
  if (!A) {
    AddLog('[UI] ACAPI недоступен');
    return;
  }

  const offsetStr = document.getElementById('groundOffset').value;
  AddLog('[UI] DEBUG: groundOffset.value = "' + offsetStr + '"');
  const offsetMm  = parseFloat(offsetStr);
  AddLog('[UI] DEBUG: parseFloat result = ' + offsetMm);
  if (isNaN(offsetMm)) {
    AddLog('[UI] Неверное значение смещения');
    setInfo("info-ground", "❌ Неверное значение смещения");
    return;
  }

  const offsetM = offsetMm / 1000.0;
  AddLog('[UI] Применение смещения Z: ' + offsetMm + ' мм (' + offsetM + ' м)');
  setInfo("info-ground", "Применение смещения...");

  if (typeof A.ApplyZDelta === 'function') {
    try {
      AddLog('[UI] DEBUG: Вызываем A.ApplyZDelta(' + offsetM + ')');
      AddLog('[UI] DEBUG: offsetM type=' + typeof offsetM + ', value=' + offsetM);
      // Принудительно преобразуем в строку, чтобы избежать INTEGER
      const success = await A.ApplyZDelta(offsetM.toString());
      AddLog('[UI] DEBUG: A.ApplyZDelta вернул: ' + success);
      if (success) {
        AddLog('[UI] ✅ Смещение применено успешно');
        setInfo("info-ground", "✅ Смещение применено: " + offsetMm + " мм");
      } else {
        AddLog('[UI] ❌ Ошибка применения смещения');
        setInfo("info-ground", "❌ Ошибка применения смещения (проверьте выделение)");
      }
    } catch (err) {
      AddLog('[UI] ❌ Ошибка вызова ApplyZDelta: ' + err);
      setInfo("info-ground", "❌ Ошибка: " + err);
    }
  } else {
    AddLog('[UI] ❌ Функция ApplyZDelta недоступна');
    setInfo("info-ground", "❌ Функция недоступна (обновите плагин)");
  }
}


    async function LandToMeshUI() {
      const A = window.ACAPI;
      if (!A) {
        AddLog('[UI] ACAPI unavailable');
        return;
      }

      AddLog('[UI] Приземление на 3D-сетку');
      setInfo("info-ground", "Приземление на 3D-сетку...");

      // Сначала автоматически устанавливаем 3D-сетку и объекты из текущего выделения
      try {
        // Устанавливаем 3D-сетку
        AddLog('[UI] Установка 3D-сетки из выделения...');
        const surfaceSuccess = await A.SetGroundSurface();
        if (!surfaceSuccess) {
          AddLog('[UI] ❌ Не удалось установить 3D-сетку');
          setInfo("info-ground", "❌ Не удалось установить 3D-сетку. Убедитесь, что в выделении есть 3D-сетка");
          return;
        }

        // Устанавливаем объекты
        AddLog('[UI] Установка объектов из выделения...');
        const objectsSuccess = await A.SetGroundObjects();
        if (!objectsSuccess) {
          AddLog('[UI] ❌ Не удалось установить объекты');
          setInfo("info-ground", "❌ Не удалось установить объекты. Убедитесь, что в выделении есть объекты для приземления");
          return;
        }

        // Теперь выполняем приземление
        AddLog('[UI] Выполнение приземления...');
        const success = await A.ApplyGroundOffset(0.0);
        if (success) {
          AddLog('[UI] ✅ Приземление выполнено успешно');
          setInfo("info-ground", "✅ Объекты приземлены на 3D-сетку");
        } else {
          AddLog('[UI] ❌ Ошибка приземления');
          setInfo("info-ground", "❌ Ошибка приземления");
        }
      } catch (err) {
        AddLog('[UI] ❌ Ошибка: ' + err);
        setInfo("info-ground", "❌ Ошибка: " + err);
      }
    }

    function onShift(mm) {
      const m = parseFloat(mm) / 1000;
      AddLog(`[UI] Shift click, delta=${m} m`);
      if (window.ACAPI_Call) ACAPI_Call('ApplyZDelta', m);
    }
    function onLand() {
      AddLog(`[UI] Land click`);
      if (window.ACAPI_Call) ACAPI_Call('ApplyGroundOffset', 0.0);
    }

    // =============== tabs / init ===============
    function openTab(evt, tabId) {
      const contents = document.getElementsByClassName("tabcontent");
      const links = document.getElementsByClassName("tablink");
      for (let i = 0; i < contents.length; i++) contents[i].style.display = "none";
      for (let i = 0; i < links.length; i++) links[i].classList.remove("active");
      const tab = document.getElementById(tabId);
      if (tab) tab.style.display = "block";
      evt.currentTarget.classList.add("active");
      AddLog('[UI] Tab → ' + tabId);
    }
    window.openTab = openTab;

    window.addEventListener('DOMContentLoaded', function () {
      AddLog("[UI] Ready (UI v0.4)");
      AddLog("[UI] Поле для логов восстановлено и готово к работе!");

      // Enter-нажатия для числовых полей
      document.getElementById('distStep')    ?.addEventListener('keydown', e => { if (e.key === 'Enter') SetDistributionStep(); });
      document.getElementById('distCount')   ?.addEventListener('keydown', e => { if (e.key === 'Enter') SetDistributionCount(); });
      document.getElementById('groundOffset')?.addEventListener('keydown', e => { if (e.key === 'Enter') whenACAPIReadyDo(ApplyZDeltaUI); });
      document.getElementById('shellWidth')  ?.addEventListener('keydown', e => { if (e.key === 'Enter') CreateShellFromLine(); });
      document.getElementById('shellStep')   ?.addEventListener('keydown', e => { if (e.key === 'Enter') CreateShellFromLine(); });

      // Enter для ID только внутри вкладки Слои (ID)
      document.getElementById('baseID')      ?.addEventListener('keydown', e => { if (e.key === 'Enter') changeAllSelectedIDs(); });
      document.getElementById('layerFolder') ?.addEventListener('keydown', e => { if (e.key === 'Enter') createLayerAndMoveElements(); });
      document.getElementById('layerName')   ?.addEventListener('keydown', e => { if (e.key === 'Enter') createLayerAndMoveElements(); });
      
      // Enter для разметки
      document.getElementById('markupStep')  ?.addEventListener('keydown', e => { if (e.key === 'Enter') whenACAPIReadyDo(SetMarkupStepUI); });

      // help-кнопки (делегирование)
      document.addEventListener('click', function (e) {
        const el = e.target.closest('[data-help-url]');
        if (!el) return;
        e.preventDefault();
        let url = el.getAttribute('data-help-url') || 'https://landscape.227.info/help/start';
        const separator = url.includes('?') ? '&' : '?';
        const timestamp = Date.now();
        url = url + separator + 'v=' + timestamp;
        AddLog('[UI] help → ' + url);

        const A = window.ACAPI;
        if (A && typeof A.OpenHelp === 'function') {
          Promise
            .resolve(A.OpenHelp(url))
            .then(() => AddLog('[UI] ACAPI.OpenHelp ok'))
            .catch(err => AddLog('[UI] ACAPI.OpenHelp error: ' + err));
        } else {
          AddLog('[UI] ACAPI.OpenHelp не найден → window.open');
          window.open(url, '_blank', 'noopener,noreferrer');
        }
      });

      // ждём мост и только затем обновляем таблицу
      whenACAPIReadyDo(() => {
        UpdateSelectedElements();
      });

      // по умолчанию открываем Распределение
      const distribTab = document.querySelector('button[onclick*="tab-distrib"]');
      if (distribTab) distribTab.click();
    });
  </script>
</head>

<body>
  <!-- Логотип LANDSCAPE HELPER -->
  <div class="logo-container">
    <div class="logo-icon">
      <div class="mountain"></div>
    </div>
    <div class="logo-text">
      <div class="logo-title">LANDSCAPE HELPER</div>
      <div class="logo-subtitle">SMART LANDSCAPE AUTOMATION ADD-ON</div>
    </div>
  </div>

  <!-- Selection Table -->
  <table class="selection-table">
    <thead>
      <tr><th colspan="4">Selected Elements:</th></tr>
      <tr><th>Type</th><th>ID</th><th>Layer</th><th>Count</th></tr>
    </thead>
    <tbody id="selection"><tr><td colspan="4">No selected elements</td></tr></tbody>
  </table>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tablink" onclick="openTab(event,'tab-distrib')">Distribution</button>
    <button class="tablink" onclick="openTab(event,'tab-orient')">Orientation</button>
    <button class="tablink" onclick="openTab(event,'tab-ground')">Grounding</button>
    <button class="tablink" onclick="openTab(event,'tab-markup')">Markup</button>
    <button class="tablink" onclick="openTab(event,'tab-shell')">Contours</button>
    <button class="tablink" onclick="openTab(event,'tab-id')">ID</button>
    <button class="tablink" onclick="openTab(event,'tab-layers')">Layers</button>
  </div>

  <!-- Distribution -->
  <div id="tab-distrib" class="tabcontent">
    <fieldset class="control-block">
      <legend>Distribution</legend>
      <div style="text-align:center;">
        <input type="button" onclick="SetDistributionLine()" value="Set Line"><br><br>
        <input type="button" onclick="SetDistributionObject()" value="Set Object">
      </div>
      <div>
        <label>Distance:</label>
        <input type="number" id="distStep" step="1" value="0">
        <input type="button" onclick="SetDistributionStep()" value="OK">
      </div>
      <div>
        <label>Count:</label>
        <input type="number" id="distCount" step="1" value="1">
        <input type="button" onclick="SetDistributionCount()" value="OK">
      </div>
      <div id="info-dist" class="info-box">Hint: set parameters</div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/distribution?embed=1"
            data-help-title="Help: Distribution">Help</button>
  </div>

  <!-- Orientation -->
  <div id="tab-orient" class="tabcontent">
    <fieldset class="control-block">
      <legend>Orientation</legend>
      <div>
        <label>Angle:</label>
        <input type="number" id="rotateAngle" step="1" value="0">
        <input type="button" onclick="RotateSelection()" value="Rotate">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <input type="button" onclick="AlignSelectionX()" value="Align to X"><br><br>
        <input type="button" onclick="RandomizeAngles()" value="Random Angle (0-360)"><br><br>
        <input type="button" onclick="OrientObjectsToPoint()" value="Orient to Point">
      </div>
      <div id="info-orient" class="info-box">Hint: set angle or choose action</div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/orientation?embed=1"
            data-help-title="Help: Orientation">Help</button>
  </div>

  <!-- Grounding -->
  <div id="tab-ground" class="tabcontent">
    <fieldset class="control-block">
      <legend>Grounding</legend>

      <div style="text-align:center; margin-bottom:10px;">
        <label>Z Offset (mm):</label>
        <input type="number" id="groundOffset" step="1" value="0">
        <input id="btnApplyOffset" type="button" onclick="whenACAPIReadyDo(ApplyZDeltaUI)" value="Apply">
      </div>

      <div style="text-align:center;">
        <input id="btnLand" type="button" onclick="whenACAPIReadyDo(LandToMeshUI)" value="Land to Mesh">
      </div>

      <div id="info-ground" class="info-box">
        <strong>Instructions:</strong><br>
        1. Select 3D mesh and objects for landing simultaneously<br>
        2. Click "Land to Mesh" to place objects on 3D mesh<br>
        <br>
        <strong>Offset:</strong> "Apply" — simple Z shift (without 3D mesh)
      </div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/ground?embed=1"
            data-help-title="Help: Grounding">Help</button>
  </div>

  <!-- Markup -->
  <div id="tab-markup" class="tabcontent">
    <fieldset class="control-block">
      <legend>Dimensions and Markup</legend>

      <div style="text-align:center; margin-bottom:15px;">
        <label>Markup Step (mm):</label>
        <input type="number" id="markupStep" step="1" value="2500" min="1" placeholder="Enter step in mm">
        <input id="btnSetMarkupStep" type="button" onclick="whenACAPIReadyDo(SetMarkupStepUI)" value="Set">
      </div>

      <div style="text-align:center; margin-bottom:15px;">
        <input id="btnCreateMarkup" type="button" onclick="whenACAPIReadyDo(CreateMarkupUI)" value="Create Markup">
      </div>

      <div style="text-align:center; margin-bottom:15px;">
        <input id="btnCreateDimensionsToLine" type="button" onclick="whenACAPIReadyDo(CreateDimensionsToLineUI)" value="Dimensions to Line">
      </div>

      <div style="text-align:center; margin-bottom:15px;">
        <input id="btnCreateDimensionsBetween" type="button" onclick="whenACAPIReadyDo(CreateDimensionsBetweenUI)" value="Dimensions Between Objects">
      </div>

      <div style="text-align:center; margin-bottom:15px;">
        <input id="btnCreateDimensionsToPoint" type="button" onclick="whenACAPIReadyDo(CreateDimensionsToPointUI)" value="Dimensions to Point">
      </div>

      <div id="info-markup" class="info-box">
        <strong>Instructions:</strong><br>
        <strong>1. Create Markup:</strong><br>
        • Set markup step (e.g., 1000 mm)<br>
        • Click "Set" to apply the step<br>
        • Select objects for markup<br>
        • Click "Create Markup"<br><br>
        <strong>2. Dimensions to Line:</strong><br>
        • Select objects (Object/Column/Lamp)<br>
        • Click "Dimensions to Line"<br>
        • Specify two line points<br><br>
        <strong>3. Dimensions Between Objects:</strong><br>
        • Select objects (Object/Column/Lamp)<br>
        • Click "Dimensions Between Objects"<br><br>
        <strong>4. Dimensions to Point:</strong><br>
        • Select objects (Object/Column/Lamp)<br>
        • Click "Dimensions to Point"<br>
        • Specify target point
      </div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/dimensions"
            data-help-title="Help: Markup">Help</button>
  </div>

  <!-- Contours -->
  <div id="tab-shell" class="tabcontent">
    <fieldset class="control-block">
      <legend>Create Contours from Line</legend>

      <div style="text-align:center; margin-bottom:10px;">
        <p style="font-size:12px; color:#666;">
          1. Click "Select Line" and choose base line<br>
          2. Set contour width<br>
          3. Click button to create contours<br>
          <strong>Note:</strong> For spline step is needed, for other lines - only width
        </p>
      </div>

      <div style="text-align:center; margin-bottom:10px;">
        <input type="button" 
               onclick="SelectBaseLine()" 
               value="Select Line"
               style="font-size:14px; padding:6px 15px; font-weight:bold;">
      </div>

      <div>
        <label>Width (mm):</label>
        <input type="number" id="shellWidth" step="1" value="1000">
      </div>

      <div>
        <label>Step (mm):</label>
        <input type="number" id="shellStep" step="1" value="500">
      </div>

      <div style="text-align:center; margin-top:15px;">
        <input type="button" 
               onclick="CreateShellFromLine()" 
               value="Create Contours"
               style="font-size:16px; padding:8px 20px; font-weight:bold;">
      </div>

      <div id="info-shell" class="info-box">
        Creates contours from base line with specified parameters.<br>
        <strong>For spline:</strong> places points with given step, builds perpendiculars<br>
        <strong>For other lines:</strong> checks closure, builds perpendiculars at start/end<br>
        Creates two side contours with closing lines (for open lines).<br>
        <strong>Attention:</strong> First select base line (spline/polyline/arc/line).
      </div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/shell"
            data-help-title="Help: Contours">Help</button>
  </div>

  <!-- ID -->
  <div id="tab-id" class="tabcontent">
    <fieldset class="control-block">
      <legend>Bulk Set ID for Selected Elements</legend>

      <div style="text-align:center; margin-bottom:10px;">
        <p style="font-size:12px; color:#666;">
          Renames ALL selected elements.<br>
          New IDs will be like "Name-01", "Name-02", "Name-03"...<br>
          Layer remains unchanged.
        </p>
      </div>

      <label for="baseID">Base Name:</label>
      <input type="text" id="baseID" placeholder="e.g.: Common Pine" style="width: 200px; padding: 3px; margin: 3px 0;" />
      <br>
      <input type="button" value="Set ID for Selected Elements" onclick="changeAllSelectedIDs()" style="margin-top: 10px;" />

      <div class="info-box" id="id-change-info">
        Enter base name and click button. All selected elements will get ID with number (e.g.: Common Pine-01, Common Pine-02...)
      </div>

      <button class="tab-help"
              data-help-url="https://landscape.227.info/help/selection"
              data-help-title="Help: Element Selection">Help</button>
    </fieldset>
  </div>

  <!-- Layers -->
  <div id="tab-layers" class="tabcontent">
    <!-- Create folder/layer + move elements -->
    <fieldset class="control-block">
      <legend>Create Folder/Layer and Move Elements</legend>

      <div style="text-align:center; margin-bottom:15px;">
        <p style="font-size:12px; color:#666;">
          1. Select elements (see table above)<br>
          2. Specify layer folder path (e.g.: "Landscape/Plants")<br>
          3. Specify new layer name<br>
          4. Click "Create and Move"<br>
          <small style="color:#888;">Element IDs can be changed separately in the block above</small>
        </p>
      </div>

      <div>
        <label>Layer Folder:</label>
        <input type="text" id="layerFolder" placeholder="e.g.: Landscape/Plants" style="width: 250px; padding: 3px; margin: 3px 0;" />
        <br>
        <small style="color:#666;">Separate subfolders with "/" (e.g.: "Landscape/Plants/Trees")</small>
      </div>

      <div>
        <label>New Layer:</label>
        <input type="text" id="layerName" placeholder="e.g.: Common Pines" style="width: 250px; padding: 3px; margin: 3px 0;" />
      </div>

      <div style="text-align:center; margin-top:15px;">
        <input type="button" 
               onclick="createLayerAndMoveElements()" 
               value="Create and Move"
               style="font-size:16px; padding:8px 20px; font-weight:bold; background:#4F604F; color:white; border:none; border-radius:4px; cursor:pointer;">
      </div>

      <div id="info-layers" class="info-box">
        What will happen:<br>
        • Layer folder will be created (if it doesn't exist)<br>
        • New layer will be created in this folder<br>
        • All selected elements will be moved to this layer<br>
        • Element IDs will remain the same (can be changed separately)<br>
        • This can be undone with Ctrl+Z
      </div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/layers"
            data-help-title="Help: Layers and ID">Help</button>
  </div>

  <div id="log-box">[Plugin log will appear here]</div>

  <a href="#"
     data-help-url="https://landscape.227.info/?embed=1"
     data-help-title="LandscapeHelper — website">
    landscape.227.info
  </a>
</body>
</html>
